# https://karpenter.sh/v0.32/concepts/nodeclasses/

apiVersion: karpenter.k8s.aws/v1beta1
kind: EC2NodeClass
metadata:
  name: {{ .Values.karpenter_nodeclass_arm64_name }}
spec:
  amiFamily: Bottlerocket

  instanceProfile: "{{ .Values.karpenter_instance_profile }}"

  # Required, discovers subnets to attach to instances
  subnetSelectorTerms:
    - tags:
        karpenter.sh/discovery: {{ .Values.env }}

  # Required, discovers security groups to attach to instances
  securityGroupSelectorTerms:
    - tags:
        karpenter.sh/discovery: {{ .Values.cluster_name }}

  # Optional, overrides autogenerated userdata with a merge semantic
  userData: |
    [settings.kubernetes]
    registry-qps = 0
    image-gc-high-threshold-percent = "85"
    image-gc-low-threshold-percent = "80"

    [settings.container-registry.mirrors]
    "docker.io" = ["https://docker-proxy.whoosh-cloud.com"]

  # Optional, propagates tags to underlying EC2 resources
  tags:
    Name: {{ .Values.cluster_name }}-karpenter-{{ .Values.karpenter_nodeclass_arm64_name }}

  # Optional, configures storage devices for the instance
  blockDeviceMappings:
    # Root device
    - deviceName: /dev/xvda
      ebs:
        volumeSize: 10Gi
        volumeType: gp2
        deleteOnTermination: {{ .Values.karpenter_nodeclass_ebs_delete_on_termination }}
    # Data device: Container resources such as images and logs
    - deviceName: /dev/xvdb
      ebs:
        volumeSize: {{ .Values.karpenter_nodeclass_ebs_size }}
        volumeType: {{ .Values.karpenter_nodeclass_ebs_type }}
        deleteOnTermination: {{ .Values.karpenter_nodeclass_ebs_delete_on_termination }}

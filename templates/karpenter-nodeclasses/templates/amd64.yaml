# https://karpenter.sh/v0.32/concepts/nodeclasses/

apiVersion: karpenter.k8s.aws/v1beta1
kind: EC2NodeClass
metadata:
  name: {{ .Values.karpenter_nodeclass_amd64_name }}
spec:
  amiFamily: AL2

  instanceProfile: "{{ .Values.karpenter_instance_profile }}"

  # Required, discovers subnets to attach to instances
  subnetSelectorTerms:
    - tags:
        karpenter.sh/discovery: {{ .Values.env }}

  # Required, discovers security groups to attach to instances
  securityGroupSelectorTerms:
    - tags:
        karpenter.sh/discovery: {{ .Values.cluster_name }}

  # Optional, overrides autogenerated userdata with a merge semantic
  userData: |
    MIME-Version: 1.0
    Content-Type: multipart/mixed; boundary="BOUNDARY"

    --BOUNDARY
    Content-Type: text/x-shellscript; charset="us-ascii"

    #!/bin/bash

    echo "Adding registryPullQPS=0 to /etc/kubernetes/kubelet/kubelet-config.json";

    yum install jq -y;

    echo "$(jq ".registryPullQPS=0" /etc/kubernetes/kubelet/kubelet-config.json)" > /etc/kubernetes/kubelet/kubelet-config.json;

    --BOUNDARY--

  # Optional, propagates tags to underlying EC2 resources
  tags:
    Name: {{ .Values.cluster_name }}-karpenter-{{ .Values.karpenter_nodeclass_amd64_name }}

  # Optional, configures storage devices for the instance
  blockDeviceMappings:
    - deviceName: /dev/xvda
      ebs:
        volumeSize: {{ .Values.karpenter_nodeclass_ebs_size }}
        volumeType: {{ .Values.karpenter_nodeclass_ebs_type }}
        deleteOnTermination: {{ .Values.karpenter_nodeclass_ebs_delete_on_termination }}
